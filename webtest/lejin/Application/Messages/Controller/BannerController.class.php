<?phpnamespace Messages\Controller;use Admin\Controller\CommonController;use Messages\Model\BannerModel;class BannerController extends CommonController {    protected $db;    function _initialize() {        parent::_initialize();        $this->db = new BannerModel();    }    /**     * 广告列表     * @param number $page     * @param number $rows     * @param array  $search     */    function index($page=1, $rows=10, $search = array()){        if (IS_POST){            $map   = array();            $limit = ($page - 1) * $rows . "," . $rows;            $total = $this->db->where($map)->count();            $list  = $total ? $this->db->where($map)->order('id desc')->limit($limit)->select() : array();            if ($total){                foreach ($list as $k=>&$v){                    switch ($v['action']){                        case 0:                            $v['actiontext'] = '留言';                            break;                        case 1:                            $v['actiontext'] = '关注';                            break;                        case 2:                            $v['actiontext'] = '动态';                            break;                        case 3:                            $v['actiontext'] = '附近';                            break;                    }                }            }            $this->ajaxReturn(array('total'=>$total, 'rows'=>$list));        }else {            $this->currentpos = $this->menu_db->currentPos(I('menuid'));  //栏目位置            $this->display('list');        }    }    /**     * 添加     */    function add(){        if (IS_POST){            $data = $_POST;            if (!$data['image']) $this->error('请上传广告图片');            if ($data['type']){                if (!$data['content']) $this->error('请输入网址');                if (!preg_match("/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\’:+!]*([^<>\"])*$/", $data['content'])){                    $this->error('请输入正确的网站地址');                }            }else {                if (!$data['content']) $this->error('请输入文本内容');            }            $data['createtime'] = NOW_TIME;            if ($this->db->add($data)){                $this->success('添加成功');            }else {                $this->error('添加失败');            }        }else {            $this->rand = I('rand');            $this->display('add');        }    }    /**     * 编辑     */    function edit($id=0){        if (IS_POST) {            $data = $_POST;            if (!$data['image']) $this->error('请上传广告图片');            if ($data['type']){                if (!$data['content']) $this->error('请输入网址');                if (!preg_match("/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\’:+!]*([^<>\"])*$/", $data['content'])){                    $this->error('请输入正确的网站地址');                }            }else {                if (!$data['content']) $this->error('请输入文本内容');            }                        if ($this->db->where(array('id'=>$id))->save($data)){                $this->success('编辑成功');            }else {                $this->error('编辑失败');            }        }else {            $this->info = $this->db->find($id);            $this->rand = I('rand');            $this->display('edit');        }    }    /**     * 删除     * @param unknown $uid     */    function delete($id){        if ($this->db->where(array('id'=>$id))->delete()) {            $this->success('删除成功');        }        $this->error('删除失败');    }    /**     * 上传图片     */    function public_upload() {        $image = upload();        if (is_array($image)) {            $this->ajaxReturn(array('status'=>1, 'info'=>'上传成功', 'image'=>$image));        }else {            $this->ajaxReturn(array('status'=>0, 'info'=>$image));        }    }}